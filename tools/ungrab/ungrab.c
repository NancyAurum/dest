/*
  UnGrab
  A command line utility which should ideally reverse the result of the
    st.exe grab 

  In other words will hopefully unpack files from the STRONG.DAT,
  recovering names, types and folder structure.

  Example use:
    ./build.bat && ./ungrab.exe ../../../dest_data/STRONG.DAT ./out


                                         -Nancy Sadkov

*/

#include <stdint.h>
#include <stddef.h>
#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>

#include "nap.h"
#include "pic.h"


#define NG_UTIL_IMPLEMENTATION
#include "util.h"


#define STB_DS_IMPLEMENTATION
#include "stb_ds.h"

//ensures compiler wont add gaps between the fields.
#define PACKED __attribute__((packed)) 

//FIXME: map file hash to filename, in case we encounter STRONG.DAT with
//unknown entries.

typedef struct { //content table entry
  uint8_t state;     //0=disk, 1=loaded
  uint32_t ofs;      //offset inside STRONG.DAT
  uint32_t sz;       //size of the file
  uint8_t info[12];  //0s when in STRONG.DAT
} PACKED cte_t; //21 bytes in size

//palettes have type==0, they are at 741, 906, 917 1451, 1453, 1455, 1457

typedef struct { //stronghold graphics type1 (header size = 9)
  uint8_t type; //=1 (UI)
  uint32_t sz;
  uint16_t w;
  uint16_t h;
  //uint8 data[sz]; //RLE-packed pixels
                    //the first data byte could be either pixel or
                    //additional info
} PACKED stg_t;


typedef struct { //stronghold graphics type2 (header size = 0xE)
  uint8_t type;  //=2 (building)
  int16_t x;
  int16_t y;
  uint8_t type2; //=1
  uint32_t sz;
  uint16_t w;
  uint16_t h;
  //uint8 data[sz]; //RLE-packed pixels
                    //the first data byte could be either pixel or
                    //additional info
} PACKED stg2_t;

typedef struct { //stronghold audio (header size = 0xD)
  uint8_t type; //=3 (audio file)
  uint16_t w; //0
  uint16_t h; //0
  uint16_t sz;
  uint8_t unk[6]; //3C 00 07 B8 __ __ = preprocesed VOC
                  // unsigned 8bit PCM, little-ending, mono, 11025Hz
                  //00 3F 3F 00 00 00 = XMI
                  //07 00 10 00 00 00 = XMI
                  //3C 00 07 B8 00 00 = XMI
  //uint8 data[sz]; //RLE-packed pixels
                    //the first data byte could be either pixel or
                    //additional info
} PACKED stg3_t;


typedef struct { //stronghold graphics type4 (header size = 0x14)
  uint8_t type; //=4 (unit)
  uint8_t unk[5];
  uint8_t type2; //=2
  int16_t x;
  int16_t y;
  uint8_t type1;
  uint32_t sz;
  uint16_t w;
  uint16_t h;
  //uint8 data[sz]; //RLE-packed pixels
                    //the first data byte could be either pixel or
                    //additional info
} PACKED stg4_t;

void fail(char *fmt, ...) {
  va_list ap;
  va_start(ap, fmt);
  int l = vsnprintf(NULL, 0, fmt, ap);
  va_end(ap);
  char *s = NULL;
  arrsetlen(s, l+1);
  va_start(ap, fmt);
  vsprintf(s, fmt, ap);
  va_end(ap);
  fprintf(stderr, "%s\n", s);
  exit(-1);
}


void usage() {
#define P printf
  P("UnGrab v0.1 by Nancy Sadkov\n");
  P("Usage: ungrab path/to/STRONG.DAT output/folder/\n");
  P("\n");
  exit(0);
#undef P
}

typedef struct { //extended information
  int ext;
  int16_t sx;
  int16_t sy;
  int16_t ex; //inclusive
  int16_t ey;
  int16_t ox;
  int16_t oy;
  int nid; //name id
} einfo_t;


einfo_t einfo[] = {
  //mouse03.lbm (mouse cursors)
  {0,  0,  0, 10, 15,  0,  0, 129}, //main pointer
  {0, 77, 11, 93, 27,  0,  0, 129}, //shovel
  {0, 96, 55,109, 62,  0,  0, 129}, //eye
  {0,159, 22,171, 32,  0,  0, 129}, //target

  //bigcomp.lbm (compass)
  {0,  1,  1, 51, 43,  0,  0,   1},
  {0, 53,  1,103, 43,  0,  0,   1},
  {0,105,  1,155, 43,  0,  0,   1},
  {0,157,  1,207, 43,  0,  0,   1},
  {0,  1, 45, 51, 87,  0,  0,   1},
  {0, 53, 45,103, 87,  0,  0,   1},
  {0,105, 45,155, 87,  0,  0,   1},
  {0,157, 45,207, 87,  0,  0,   1},

  //hourgls4.lbm (hourglass)
  {0,  6, 21, 27, 62,  0,  0, 508},
  {0, 29, 21, 50, 62,  0,  0, 508},
  {0, 52, 21, 73, 62,  0,  0, 508},
  {0, 75, 21, 96, 62,  0,  0, 508},
  {0, 98, 21,119, 62,  0,  0, 508},
  {0,121, 21,142, 62,  0,  0, 508},
  {0,144, 21,165, 62,  0,  0, 508},
  {0,167, 21,188, 62,  0,  0, 508},
  {0,190, 21,211, 62,  0,  0, 508},
  {0,213, 21,234, 62,  0,  0, 508},
  {0,236, 21,257, 62,  0,  0, 508},
  {0,259, 21,280, 62,  0,  0, 508},
  //smaller hourglass anim
  {0,  9, 72, 22, 75,  0,  0, 508},
  {0, 32, 72, 45, 75,  0,  0, 508},
  {0, 55, 72, 68, 75,  0,  0, 508},
  {0, 78, 72, 91, 75,  0,  0, 508},
  {0,101, 72,114, 75,  0,  0, 508},
  {0,124, 72,137, 75,  0,  0, 508},

  //frmlnd.lbm
  {0, 40,173, 50,179,  0,  0,  80},
  {0,140,108,150,114,  0,  0,  80},
  {0,240, 43,252, 49,  0,  0,  80},
  {0, 40,108, 50,114,  0,  0,  80},
  {0,140,173,150,179,  0,  0,  80},
  {0,240,108,252,114,  0,  0,  80},


  //build/geninn01.lbm (inn sprites)
  //lv1
  {0,9,130,97,194,11,-5,387},
  {0,100,130,199,194,11,-5,387},
  {0,204,130,292,194,11,-5,387},
  //Lv2
  {0,9,65,97,129,11,-5,387},
  {0,100,65,199,129,11,-5,387},
  {0,204,65,292,129,11,-5,387},
  //Lv3
  {0,9,0,97,64,11,-5,387},
  {0,108,0,191,64,11,-5,387},
  {0,204,0,292,64,11,-5,387},

  //build/geninn02.lbm (ruined inn sprites)
  {0,9,130,97,194,11,-5,485},
  {0,100,130,199,194,11,-5,485},
  {0,204,130,292,194,11,-5,485},
  {0,9,65,97,129,11,-5,485},
  {0,100,65,199,129,11,-5,485},
  {0,204,65,292,129,11,-5,485},
  {0,9,0,97,64,11,-5,485},
  {0,108,0,191,64,11,-5,485},
  {0,204,0,292,64,11,-5,485},

  //build/magres01.lbm
  {0,0,130,99,194,26,-1,392},
  {0,100,130,199,194,26,-1,392},
  {0,200,130,299,194,26,-1,392},
  {0,0,65,99,129,26,-1,392},
  {0,100,65,199,129,26,-1,392},
  {0,200,65,299,129,26,-1,392},
  {0,0,0,99,64,26,7,392},
  {0,100,0,199,64,26,7,392},
  {0,200,0,299,64,26,7,392},

  //build/magres02.lbm
  {0,0,130,99,194,26,-1,393},
  {0,100,130,199,194,26,-1,393},
  {0,200,130,299,194,26,-1,393},
  {0,0,65,99,129,26,-1,393},
  {0,100,65,199,129,26,-1,393},
  {0,200,65,299,129,26,-1,393},
  {0,0,0,99,64,26,7,393},
  {0,100,0,199,64,26,7,393},
  {0,200,0,299,64,26,7,393},

  //build/cletem01.lbm
  {0,6,151,91,180,0,-25,56},
  {0,110,151,185,180,0,-25,56},
  {0,216,151,299,180,0,-25,56},
  {0,6,72,91,115,0,-11,56},
  {0,110,72,185,115,0,-11,56},
  {0,216,72,299,115,0,-11,56},
  {0,6,6,91,59,0,-1,56},
  {0,110,6,185,59,0,-1,56},
  {0,216,6,299,59,0,-1,56},

   //psVar14 = grabLbmTR(444);
  {0,6,151,91,180,0,-25,444},
  {0,110,151,185,180,0,-25,444},
  {0,216,151,299,180,0,-25,444},
  {0,6,72,91,115,0,-11,444},
  {0,110,72,185,115,0,-11,444},
  {0,216,72,299,115,0,-11,444},
  {0,6,6,91,59,0,-1,444},
  {0,110,6,185,59,0,-1,444},
  {0,216,6,299,59,0,-1,444},

  //psVar14 = grabLbmTR(447);
  {0,2,130,89,180,0,-3,447},
  {0,108,130,191,180,0,-3,447},
  {0,212,130,298,180,0,-3,447},
  {0,2,65,89,115,0,-3,447},
  {0,108,65,191,115,0,-3,447},
  {0,212,65,298,115,0,-3,447},
  {0,2,9,89,59,0,-3,447},
  {0,108,9,191,59,0,-3,447},
  {0,212,9,298,59,0,-3,447},


  //psVar14 = grabLbmTR(448);
  {0,2,130,89,180,0,-3,448},
  {0,108,130,191,180,0,-3,448},
  {0,212,130,298,180,0,-3,448},
  {0,2,65,89,115,0,-3,448},
  {0,108,65,191,115,0,-3,448},
  {0,212,65,298,115,0,-3,448},
  {0,2,9,89,59,0,-3,448},
  {0,108,9,191,59,0,-3,448},
  {0,212,9,298,59,0,-3,448},

  //115 - grabBldLbm
  {0,0,130,99,194,26,-1,115},
  {0,100,130,199,194,26,-1,115},
  {0,200,130,299,194,26,-1,115},
  {0,0,65,99,129,26,-1,115},
  {0,100,65,199,129,26,-1,115},
  {0,200,65,299,129,26,-1,115},
  {0,0,0,99,64,26,-1,115},
  {0,100,0,199,64,26,-1,115},
  {0,200,0,299,64,26,-1,115},
  
  //116 - grabBldLbm
  {0,0,130,99,194,26,-1,116},
  {0,100,130,199,194,26,-1,116},
  {0,200,130,299,194,26,-1,116},
  {0,0,65,99,129,26,-1,116},
  {0,100,65,199,129,26,-1,116},
  {0,200,65,299,129,26,-1,116},
  {0,0,0,99,64,26,-1,116},
  {0,100,0,199,64,26,-1,116},
  {0,200,0,299,64,26,-1,116},


  //312 - grabBldLbm
  {0,0,130,99,194,26,-1,312},
  {0,100,130,199,194,26,-1,312},
  {0,200,130,299,194,26,-1,312},
  {0,0,65,99,129,26,-1,312},
  {0,100,65,199,129,26,-1,312},
  {0,200,65,299,129,26,-1,312},
  {0,0,0,99,64,26,-1,312},
  {0,100,0,199,64,26,-1,312},
  {0,200,0,299,64,26,-1,312},

  
  //446 - grabBldLbm
  {0,0,130,99,194,26,-1,446},
  {0,100,130,199,194,26,-1,446},
  {0,200,130,299,194,26,-1,446},
  {0,0,65,99,129,26,-1,446},
  {0,100,65,199,129,26,-1,446},
  {0,200,65,299,129,26,-1,446},
  {0,0,0,99,64,26,-1,446},
  {0,100,0,199,64,26,-1,446},
  {0,200,0,299,64,26,-1,446},

  //312 - grabBldLbm
  {0,0,130,99,194,26,-1,312},
  {0,100,130,199,194,26,-1,312},
  {0,200,130,299,194,26,-1,312},
  {0,0,65,99,129,26,-1,312},
  {0,100,65,199,129,26,-1,312},
  {0,200,65,299,129,26,-1,312},
  {0,0,0,99,64,26,-1,312},
  {0,100,0,199,64,26,-1,312},
  {0,200,0,299,64,26,-1,312},

  //313- grabBldLbm
  {0,0,130,99,194,26,-1,313},
  {0,100,130,199,194,26,-1,313},
  {0,200,130,299,194,26,-1,313},
  {0,0,65,99,129,26,-1,313},
  {0,100,65,199,129,26,-1,313},
  {0,200,65,299,129,26,-1,313},
  {0,0,0,99,64,26,-1,313},
  {0,100,0,199,64,26,-1,313},
  {0,200,0,299,64,26,-1,313},


  //psVar14 = grabLbmTR(459);
  {0,9,68,92,182,-4,56,459},
  {0,108,68,191,182,-3,566,459},
  {0,208,68,291,182,-1,566,459},


  //tg = grabLbmTR(460);
  {0,9,68,92,182,-4,56,560},
  {0,108,68,191,182,-3,56,560},
  {0,208,68,291,182,-1,56,560},


  //grabLbmTR(172);
  {0, 20, 33, 99,116,  8, 28, 172},
  {0,120, 33,199,116,  8, 28, 172},
  {0,220, 33,299,116,  8, 28, 172},

  //grabLbmTR(175);
  {0, 20, 33, 99,116,  8, 28, 175},
  {0,120, 33,199,116,  8, 28, 175},
  {0,220, 33,299,116,  8, 28, 175},


  //psVar14 = grabLbmTR(174);
  {0,100,130,199,194,26,-4,174},
  {0,100,65,199,129,26,-4,174},
  {0,100,0,199,64,26,-4,174},
  
  //tg = grabLbmTR(176);
  {0,100,130,199,194,26,-4,176},
  {0,100,65,199,129,26,-4,176},
  {0,100,0,199,64,26,-4,176},



  //449 - grabBldLbm
  {0,0,130,99,194,26,-1,449},
  {0,100,130,199,194,26,-1,449},
  {0,200,130,299,194,26,-1,449},
  {0,0,65,99,129,26,-1,449},
  {0,100,65,199,129,26,-1,449},
  {0,200,65,299,129,26,-1,449},
  {0,0,0,99,64,26,-1,449},
  {0,100,0,199,64,26,-1,449},
  {0,200,0,299,64,26,-1,449},

  //450- grabBldLbm
  {0,0,130,99,194,26,-1,313},
  {0,100,130,199,194,26,-1,313},
  {0,200,130,299,194,26,-1,313},
  {0,0,65,99,129,26,-1,313},
  {0,100,65,199,129,26,-1,313},
  {0,200,65,299,129,26,-1,313},
  {0,0,0,99,64,26,-1,313},
  {0,100,0,199,64,26,-1,313},
  {0,200,0,299,64,26,-1,313},

  //390 - grabBldLbm
  {0,0,130,99,194,26,-1,390},
  {0,100,130,199,194,26,-1,390},
  {0,200,130,299,194,26,-1,390},
  {0,0,65,99,129,26,-1,390},
  {0,100,65,199,129,26,-1,390},
  {0,200,65,299,129,26,-1,390},
  {0,0,0,99,64,26,-1,390},
  {0,100,0,199,64,26,-1,390},
  {0,200,0,299,64,26,-1,390},

  //391- grabBldLbm
  {0,0,130,99,194,26,-1,391},
  {0,100,130,199,194,26,-1,391},
  {0,200,130,299,194,26,-1,391},
  {0,0,65,99,129,26,-1,391},
  {0,100,65,199,129,26,-1,391},
  {0,200,65,299,129,26,-1,391},
  {0,0,0,99,64,26,-1,391},
  {0,100,0,199,64,26,-1,391},
  {0,200,0,299,64,26,-1,391},

  //389 - grabBldLbm
  {0,0,130,99,194,26,-1,389},
  {0,100,130,199,194,26,-1,389},
  {0,200,130,299,194,26,-1,389},
  {0,0,65,99,129,26,-1,389},
  {0,100,65,199,129,26,-1,389},
  {0,200,65,299,129,26,-1,389},
  {0,0,0,99,64,26,-1,389},
  {0,100,0,199,64,26,-1,389},
  {0,200,0,299,64,26,-1,389},

  //442- grabBldLbm
  {0,0,130,99,194,26,-1,442},
  {0,100,130,199,194,26,-1,442},
  {0,200,130,299,194,26,-1,442},
  {0,0,65,99,129,26,-1,442},
  {0,100,65,199,129,26,-1,442},
  {0,200,65,299,129,26,-1,442},
  {0,0,0,99,64,26,-1,442},
  {0,100,0,199,64,26,-1,442},
  {0,200,0,299,64,26,-1,442},


  //grabLbmTR(394);
  {0,6,151,91,180,-10,-26,394},
  {0,110,151,185,180,-10,-26,394},
  {0,216,151,299,180,-10,-26,394},
  {0,6,72,91,115,-10,-12,394},
  {0,110,72,185,115,-10,-12,394},
  {0,216,72,299,115,-10,-12,394},
  {0,6,6,91,59,-10,-4,394},
  {0,110,6,185,59,-10,-4,394},
  {0,216,6,299,59,-10,-4,394},

  //psVar14 = grabLbmTR(443);
  {0,6,151,91,180,-10,-26,443},
  {0,110,151,185,180,-10,-26,443},
  {0,216,151,299,180,-10,-26,443},
  {0,6,72,91,115,-10,-12,443},
  {0,110,72,185,115,-10,-12,443},
  {0,216,72,299,115,-10,-12,443},
  {0,6,6,91,59,-10,-4,443},
  {0,110,6,185,59,-10,-4,443},
  {0,216,6,299,59,-10,-4,443},


  //tg = grabLbmTR(173);
  {0,0,130,99,194,26,0,173},
  {0,100,130,199,194,26,0,173},
  {0,200,130,299,194,26,0,173},
  {0,0,65,99,129,26,0,173},
  {0,100,65,199,129,26,0,173},
  {0,200,65,299,129,26,0,173},



  //314 - grabBldLbm
  {0,0,130,99,194,26,-1,314},
  {0,100,130,199,194,26,-1,314},
  {0,200,130,299,194,26,-1,314},
  {0,0,65,99,129,26,-1,314},
  {0,100,65,199,129,26,-1,314},
  {0,200,65,299,129,26,-1,314},
  {0,0,0,99,64,26,-1,314},
  {0,100,0,199,64,26,-1,314},
  {0,200,0,299,64,26,-1,314},

  //315- grabBldLbm
  {0,0,130,99,194,26,-1,315},
  {0,100,130,199,194,26,-1,315},
  {0,200,130,299,194,26,-1,315},
  {0,0,65,99,129,26,-1,315},
  {0,100,65,199,129,26,-1,315},
  {0,200,65,299,129,26,-1,315},
  {0,0,0,99,64,26,-1,315},
  {0,100,0,199,64,26,-1,315},
  {0,200,0,299,64,26,-1,315},


  //316 - grabBldLbm
  {0,0,130,99,194,26,-1,316},
  {0,100,130,199,194,26,-1,316},
  {0,200,130,299,194,26,-1,316},
  {0,0,65,99,129,26,-1,316},
  {0,100,65,199,129,26,-1,316},
  {0,200,65,299,129,26,-1,316},
  {0,0,0,99,64,26,-1,316},
  {0,100,0,199,64,26,-1,316},
  {0,200,0,299,64,26,-1,316},

  //317- grabBldLbm
  {0,0,130,99,194,26,-1,317},
  {0,100,130,199,194,26,-1,317},
  {0,200,130,299,194,26,-1,317},
  {0,0,65,99,129,26,-1,317},
  {0,100,65,199,129,26,-1,317},
  {0,200,65,299,129,26,-1,317},
  {0,0,0,99,64,26,-1,317},
  {0,100,0,199,64,26,-1,317},
  {0,200,0,299,64,26,-1,317},


  //psVar14 = grabLbmTR(320);
  {0,58,141,134,199,-4,0,320},
  {0,58,84,134,142,-4,0,320},
  {0,58,25,134,83,-4,0,320},

  //tg = grabLbmTR(321);
  {0,58,141,134,199,-4,0,321},
  {0,58,84,134,142,-4,0,321},
  {0,58,25,134,83,-4,0,321},

  //tg = grabLbmTR(500);
  {0,  3,  0, 50, 54,  0,  1, 500},
  {0,  3, 62, 50,116,  0,  1, 500},
  {0,  3, 62, 50,116,  0,  1, 500},
  {0, 51,  0, 98, 54,  0,  1, 500},
  {0, 51, 62, 98,116,  0,  1, 500},
  {0, 51, 62, 98,116,  0,  1, 500},
  {0, 99,  0,146, 54,  0,  1, 500},
  {0, 99, 62,146,116,  0,  1, 500},
  {0, 99, 62,146,116,  0,  1, 500},
  {0,147,  0,194, 54,  0,  1, 500},
  {0,147, 62,194,116,  0,  1, 500},
  {0,147, 62,194,116,  0,  1, 500},

  //tg = grabLbmTR(501);
  {0,  3,  0, 50, 54,  0,  1, 501},
  {0,  3, 62, 50,116,  0,  1, 501},
  {0,  3, 62, 50,116,  0,  1, 501},
  {0, 51,  0, 98, 54,  0,  1, 501},
  {0, 51, 62, 98,116,  0,  1, 501},
  {0, 51, 62, 98,116,  0,  1, 501},
  {0, 99,  0,146, 54,  0,  1, 501},
  {0, 99, 62,146,116,  0,  1, 501},
  {0, 99, 62,146,116,  0,  1, 501},
  {0,147,  0,194, 54,  0,  1, 501},
  {0,147, 62,194,116,  0,  1, 501},
  {0,147, 62,194,116,  0,  1, 501},


  //tg = grabLbmTR(502);
  {0,  3,  0, 50, 54,  0,  1, 502},
  {0,  3, 62, 50,116,  0,  1, 502},
  {0,  3, 62, 50,116,  0,  1, 502},
  {0, 51,  0, 98, 54,  0,  1, 502},
  {0, 51, 62, 98,116,  0,  1, 502},
  {0, 51, 62, 98,116,  0,  1, 502},
  {0, 99,  0,146, 54,  0,  1, 502},
  {0, 99, 62,146,116,  0,  1, 502},
  {0, 99, 62,146,116,  0,  1, 502},
  {0,147,  0,194, 54,  0,  1, 502},
  {0,147, 62,194,116,  0,  1, 502},
  {0,147, 62,194,116,  0,  1, 502},

  //tg = grabLbmTR(503);
  {0,  3,  0, 50, 54,  0,  1, 503},
  {0,  3, 62, 50,116,  0,  1, 503},
  {0,  3, 62, 50,116,  0,  1, 503},
  {0, 51,  0, 98, 54,  0,  1, 503},
  {0, 51, 62, 98,116,  0,  1, 503},
  {0, 51, 62, 98,116,  0,  1, 503},
  {0, 99,  0,146, 54,  0,  1, 503},
  {0, 99, 62,146,116,  0,  1, 503},
  {0, 99, 62,146,116,  0,  1, 503},
  {0,147,  0,194, 54,  0,  1, 503},
  {0,147, 62,194,116,  0,  1, 503},
  {0,147, 62,194,116,  0,  1, 503},

  //504
  {0,  3,  0, 50, 54,  0,  1, 504},
  {0,  3, 62, 50,116,  0,  1, 504},
  {0,  3, 62, 50,116,  0,  1, 504},
  {0, 51,  0, 98, 54,  0,  1, 504},
  {0, 51, 62, 98,116,  0,  1, 504},
  {0, 51, 62, 98,116,  0,  1, 504},
  {0, 99,  0,146, 54,  0,  1, 504},
  {0, 99, 62,146,116,  0,  1, 504},
  {0, 99, 62,146,116,  0,  1, 504},
  {0,147,  0,194, 54,  0,  1, 504},
  {0,147, 62,194,116,  0,  1, 504},
  {0,147, 62,194,116,  0,  1, 504},

  //505
  {0,  3,  0, 50, 54,  0,  1, 505},
  {0,  3, 62, 50,116,  0,  1, 505},
  {0,  3, 62, 50,116,  0,  1, 505},
  {0, 51,  0, 98, 54,  0,  1, 505},
  {0, 51, 62, 98,116,  0,  1, 505},
  {0, 51, 62, 98,116,  0,  1, 505},
  {0, 99,  0,146, 54,  0,  1, 505},
  {0, 99, 62,146,116,  0,  1, 505},
  {0, 99, 62,146,116,  0,  1, 505},
  {0,147,  0,194, 54,  0,  1, 505},
  {0,147, 62,194,116,  0,  1, 505},
  {0,147, 62,194,116,  0,  1, 505},


  //11
  {0,  0,  0, 99, 64, 30, -4, 11},
  {0,100,  0,199, 64, 30, -4, 11},
  {0,200,  0,299, 64, 30, -4, 11},
  {0,  0, 65, 99,129, 30, -4, 11},
  {0,100, 65,199,129, 30, -4, 11},
  {0,200, 65,299,129, 30, -4, 11},
  {0,  0,130, 99,194, 30, -4, 11},
  {0,100,130,199,194, 30, -4, 11},
  {0,200,130,299,194, 30, -4, 11},


  //grabLbmTR(52);
  {0,167, 12,206, 32, -4,-37, 52},
  {0,167, 45,206, 65, -4,-37, 52},
  {0,167, 78,206, 98, -4,-37, 52},
  {0, 13, 20, 16, 32,-22,-44, 52},
  {0, 95, 20, 98, 32,-22,-44, 52},
  {0, 13, 53, 16, 65,-22,-44, 52},
  {0, 95, 53, 98, 65,-22,-44, 52},
  {0, 13, 86, 16, 98,-22,-44, 52},
  {0, 95, 86, 98, 98,-22,-44, 52},
  {0, 13,119, 16,131,-22,-44, 52},
  {0, 95,119, 98,131,-22,-44, 52},
  {0, 13,152, 16,164,-22,-44, 52},
  {0, 95,152, 98,164,-22,-44, 52},
  {0, 13,185, 16,197,-22,-44, 52},
  {0, 95,185, 98,197,-22,-44, 52},
  {0, 43, 20, 46, 32,-22,-44, 52},
  {0,125, 20,128, 32,-22,-44, 52},



  //psVar14 = grabLbmTR(308);
  {0,2,86,85,180,-2,38,308},
  {0,108,86,191,180,-2,38,308},
  {0,208,86,298,180,0,38,308},

  //tg = grabLbmTR(309);
  {0,2,86,85,180,-2,38,309},
  {0,108,86,191,180,-2,38,309},
  {0,208,86,298,180,0,38,309},



  //psVar14 = grabLbmTR(467);
  {0,4,74,91,180,-3,50,467},
  {0,110,74,195,180,-3,50,467},
  {0,204,74,299,180,3,50,467},


  //tg = grabLbmTR(468);
  {0,4,74,91,180,-3,50,468},
  {0,110,74,195,180,-3,50,468},
  {0,204,74,299,180,3,50,468},

  
  //psVar14 = grabLbmTR(513);
  {0,2,70,86,180,0,52,513},
  {0,108,70,191,180,0,52,513},
  {0,215,70,298,180,0,52,513},


  //psVar14 = grabLbmTR(514);
  {0,2,70,86,180,0,52,514},
  {0,108,70,191,180,0,52,514},
  {0,215,70,298,180,0,52,514},

  //psVar14 = grabLbmTR(517);
  {0,2,70,86,180,0,52,517},
  {0,108,70,191,180,0,52,517},
  {0,215,70,298,180,0,52,517},


  //psVar14 = grabLbmTR(518);
  {0,2,70,86,180,0,52,518},
  {0,108,70,191,180,0,52,518},
  {0,215,70,298,180,0,52,518},


  //psVar14 = grabLbmTR(525);
  {0,108,70,191,180,0,52,525},


  //tg = grabLbmTR(526);
  {0,108,70,191,180,0,52,526},

  //psVar14 = grabLbmTR(515);
  {0,2,70,86,180,0,52,515},
  {0,108,70,191,180,0,52,515},
  {0,215,70,298,180,0,52,515},

  //psVar14 = grabLbmTR(516);
  {0,2,70,86,180,0,52,516},
  {0,108,70,191,180,0,52,516},
  {0,215,70,298,180,0,52,516},

  //psVar14 = grabLbmTR(519);
  {0,108,70,191,180,0,52,519},


  //tg = grabLbmTR(520);
  {0,108,70,191,180,0,52,520},


  //psVar14 = grabLbmTR(521);
  {0,108,70,191,180,0,52,521},


  //tg = grabLbmTR(522);
  {0,108,70,191,180,0,52,522},


  //psVar14 = grabLbmTR(523);
  {0, 80, 39,104, 58,-68, 22, 523},
  {0,114, 39,138, 58,-68, 22, 523},
  {0,148, 39,172, 58,-68, 22, 523},
  {0,182, 39,206, 58,-68, 22, 523},
  {0,216, 39,240, 58,-68, 22, 523},
  {0, 82, 87,222,181, 22, 32, 523},
  {0, 82, 87,222,181, 22, 32, 523},


  //156
  {0,  0,101,319,199, 60, 26, 156},
  {0,  0,  0,319,100, 60, 28, 156},

  //441
  {0,  0,101,319,199, 60, 26, 441},
  {0,  0,  0,319,100, 60, 28, 441},

  //157
  {0,  0, 70,319,193, 60, 51, 157},

  //440
  {0,  0, 70,319,193, 60, 51, 440},


  //psVar14 = grabLbmTR(318);
  {0,8,50,110,154,-4,45,318},
  {0,111,50,212,154,-4,45,318},
  {0,213,50,313,154,-4,45,318},


  //tg = grabLbmTR(319);
  {0,8,50,110,154,-4,45,319},
  {0,111,50,212,154,-4,45,319},
  {0,213,50,313,154,-4,45,319},

  //tg = grabLbm(17,0,0);
  {0,135,  0,269, 64, 30,-10, 17},
  {0,  0, 65,134,129, 30,-10, 17},
  {0,135, 65,269,129, 30,-10, 17},
  {0,  0,130,134,194, 30,-10, 17},
  {0,135,130,269,194, 30,-10, 17},

  //grabLbmTR(31);  
  {0,0,18,200,33,0,0,31},
  {0,131,74,179,130,0,0,31},
  {0,31,49,79,55,0,0,31},
  {0,0,49,200,65,0,0,31},
  {0,31,74,79,130,0,0,31},
  {0,131,49,179,55,0,0,31},
  {0,0,1,200,17,0,0,31},
  {0,231,49,279,55,0,0,31},

  //psVar14 = grabLbmTR(51);
  {0,131,49,219,65,0,0,51},
  {0,131,74,179,130,0,0,51},
  {0,131,59,179,65,0,0,51},


  //psVar14 = grabLbmTR(288);
  {0,0,51,200,65,0,0,288},
  {0,31,74,79,130,0,0,288},
  {0,0,51,48,57,0,0,288},
  {0,0,14,200,28,0,0,288},
  {0,131,74,179,130,0,0,288},
  {0,0,14,48,20,0,0,288},
  {0,0,168,200,195,0,0,288},
  {0,231,74,279,130,0,0,288},
  {0,0,168,48,187,0,13,288},

  //psVar14 = grabLbmTR(462);
  {0,13,28,96,119,0,32,462},
  {0,119,28,202,119,0,32,462},
  {0,226,28,309,119,0,32,462},


  //psVar14 = grabLbmTR(463);
  {0,13,28,96,119,0,32,463},
  {0,119,28,202,119,0,32,463},
  {0,226,28,309,119,0,32,463},


  {0,0,0,0,0,0}
};


int unrle(uint8_t *src, uint8_t *dst, int sz) {
  uint8_t *q;
  uint8_t b;
  int i;
  uint8_t *end = dst + sz;
  uint8_t *ps;
  uint8_t *s = src;

  do {
    do {
      ps = s;
      s = ps + 1;
      b = *ps;
    } while (b == 0x80);
    if (b < 0x80) {
      i = (uint8_t)(b + 1);
      do {
        q = s;
        s = s + 1;
        if (*q != 0) {
          *dst = *q;
        }
        dst = dst + 1;
        i = i - 1;
      } while (i != 0);
    }
    else {
      i = (uint8_t)((b ^ 0xff) + 2);
      q = s;
      s = ps + 2;
      b = *q;
      if (b == 0) {
        dst = dst + i;
      }
      else {
        for (; i != 0; i = i - 1) {
          q = dst;
          dst = dst + 1;
          *q = b;
        }
      }
    }
  } while (dst < end);
  return s - src;
}


int is_txt(uint8_t *p, uint32_t size) {
  uint32_t i;
  if (!size) return 0;
  //if (p[size-1] != 0x1A) return 0;
  for (i = 0; i < size; i++) {
    if (p[i] >= 0x80) return 0;
    if (p[i] == 0x1A && i==size-1) continue;
    if (p[i] < 0x20 && p[i]!=0xd && p[i]!=0xa) return 0;
  }
  return 1;
}


int names_count;
char *names[5000];


void load_names() {
  if (!file_exists("./names.txt")) fail("File doesn't exist: names.txt");

  int64_t names_size;
  char *p = read_whole_file("./names.txt", &names_size);
  p[names_size-1] = 0;
  while(*p) {
    names[names_count++] = p;
    while(*p && *p != '\n') ++p;
    if (*p == '\n') *p++ = 0;
  }
}

#define true 1

void test() {
  int ii,jj,cc,iVar7,iVar2;

#if 0
  cc = 0;
  jj = 1;
  while( 1 ) {
    if (0x2d < jj) break;
    for (ii = 1; ii < 0x9e; ii = ii + 0x34) {
      printf("  {0,%3d,%3d,%3d,%3d,   1},\n", ii,jj,ii + 0x32,jj + 0x2a);
      cc = cc + 1;
    }
    jj = jj + 0x2c;
  }

  cc = 0;
  while( 1 ) {
    if (0xb < cc) break;
    printf("  {0,%3d,%3d,%3d,%3d, 508},\n", cc * 0x17 + 6,21,cc * 0x17 + 0x1b,62);
    cc = cc + 1;
  }

  for (cc = 0; cc < 6; cc = cc + 1) {
    printf("  {0,%3d,%3d,%3d,%3d, 508},\n",cc * 0x17 + 9,72,cc * 0x17 + 0x16,75);
  }

  cc = 0;
  while( 1 ) {
    if (2 < cc) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 172},\n",cc*100+0x14, 33, cc*100+99, 116,8 , 28);

    cc = cc + 1;
  }

  cc = 0;
  while( true ) {
    if (2 < cc) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 175},\n",cc * 100 + 0x14,33,cc * 100 + 99,116,8,28);
    cc = cc + 1;
  }


  iVar7 = 0;
  while( true ) {
    if (3 < iVar7) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 500},\n",iVar7 * 0x30 + 3,0,iVar7 * 0x30 + 0x32,54,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 500},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 500},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    iVar7 = iVar7 + 1;
  }


  iVar7 = 0;
  while( true ) {
    if (3 < iVar7) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 501},\n",iVar7 * 0x30 + 3,0,iVar7 * 0x30 + 0x32,54,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 501},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 501},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    iVar7 = iVar7 + 1;
  }


  iVar7 = 0;
  while( true ) {
    if (3 < iVar7) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 502},\n",iVar7 * 0x30 + 3,0,iVar7 * 0x30 + 0x32,54,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 502},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 502},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    iVar7 = iVar7 + 1;
  }

  iVar7 = 0;
  while( true ) {
    if (3 < iVar7) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 503},\n",iVar7 * 0x30 + 3,0,iVar7 * 0x30 + 0x32,54,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 503},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 503},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    iVar7 = iVar7 + 1;
  }

  iVar7 = 0;
  while( true ) {
    if (3 < iVar7) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 504},\n",iVar7 * 0x30 + 3,0,iVar7 * 0x30 + 0x32,54,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 504},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 504},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    iVar7 = iVar7 + 1;
  }

  iVar7 = 0;
  while( true ) {
    if (3 < iVar7) break;
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 505},\n",iVar7 * 0x30 + 3,0,iVar7 * 0x30 + 0x32,54,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 505},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 505},\n",iVar7 * 0x30 + 3,62,iVar7 * 0x30 + 0x32,116,0,1);
    iVar7 = iVar7 + 1;
  }

  iVar7 = 0;
  while( true ) {
    if (2 < iVar7) break;
    for (cc = 0; cc < 3; cc = cc + 1) {
      printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 11},\n",cc * 100,iVar7 * 0x41,cc * 100 + 99,iVar7 * 0x41 + 0x40,30,-4);
    }
    iVar7 = iVar7 + 1;
  }


  for (cc = 0; cc < 6; cc = cc + 1) {
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 52},\n",13,cc * 0x21 + 0x14,16,cc * 0x21 + 0x20,-22,-44);
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 52},\n",95,cc * 0x21 + 0x14,98,cc * 0x21 + 0x20,-22,-44);
  }



  for (cc = 0; cc < 5; cc = cc + 1) {
    printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 523},\n",cc * 0x22 + 0x50,39,cc * 0x22 + 0x68,58,-68,22);
  }

  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 523},\n",82,87,222,181,22,32);
  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 523},\n",82,87,222,181,22,32);


  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 156},\n",0,101,319,199,60,26);
  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 156},\n",0,0,319,100,60,28);
  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 156},\n",0,101,319,199,60,26);
  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 156},\n",0,0,319,100,60,28);
  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 156},\n",0,70,319,193,60,51);
  printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 156},\n",0,70,319,193,60,51);


  iVar2 = 0;
  while( true ) {
    if (2 < iVar2) break;
    for (cc = 0; cc < 2; cc = cc + 1) {
      if ((cc != 0) || (iVar2 != 0)) {
        printf("  {0,%3d,%3d,%3d,%3d,%3d,%3d, 17},\n",cc * 0x87,iVar2 * 0x41,cc * 0x87 + 0x86,
                                 iVar2 * 0x41 + 0x40,30,-10);
      }
    }
    iVar2 = iVar2 + 1;
  }

#endif

  exit(0);
}

int main(int argc, char **argv) {
  int i, j, k;

  NAP_INTRO
  NAP_IF("h") usage(); NAP_FI
  NAP_OUTRO(2,2)



  char *outpath = fargv[1];
  if (outpath[strlen(outpath)-1] != '/') outpath = cat(outpath,"/");

  if (!file_exists(fargv[0])) fail("File doesn't exist: %s", fargv[0]);


  load_names();
  
  test();

  
  int64_t file_size;
  uint8_t *file = read_whole_file(fargv[0], &file_size);
  uint32_t ctofs = *(uint32_t*)file; //files table offset
  uint32_t ctsz = file_size - ctofs;
  int nitems = ctsz/sizeof(cte_t);

  printf("Content Table Offset: %x\n", ctofs);
  printf("Content Table Size: %x\n", ctsz);
  printf("Number of entries: %d\n", nitems);

  //do sanity check
  if (ctofs+sizeof(cte_t)*100 > file_size
      || nitems < 100 || nitems > 0x8000
      || file_size < ctsz*10
      || ctsz%sizeof(cte_t)
      ) {
    fail("Invalid STRONG.DAT");
  }

  cte_t *ct = (cte_t*)(file+ctofs);

#if 0
  for (i = 0; i < nitems; i++) {
    printf("%04d: Ofs=%x Sz=%x\n", i, ct[i].ofs, ct[i].sz);
    if (ct[i].state) fail("entry %d has non-null state", i);
    for (j = 0; j < 12; j++)
      if (ct[i].info[j]) fail("entry %d has non-null info", i);
  }
#endif



#if 0
  for (i = 0; i < nitems; i++) {
    printf("Dumping entry %d...\n", i);
    write_whole_file_path(fmt("%s%04d",outpath, i), file+ct[i].ofs, ct[i].sz);
  }
  printf("Done!\n");
#endif


#if 1
  uint8_t *pal = file+ct[741].ofs;
  for (i = 0; i < nitems; i++) {
    einfo_t *ei = &einfo[i];
    stg_t *stg = (stg_t*)(file+ct[i].ofs);
    stg2_t *stg2 = (stg2_t*)(file+ct[i].ofs);
    stg3_t *stg3 = (stg3_t*)(file+ct[i].ofs);
    stg4_t *stg4 = (stg4_t*)(file+ct[i].ofs);
    if (stg->type==1 && stg->w && stg->h && stg->sz && stg->w <= 320 && stg->h <= 200 && stg->sz <= 320*200+9) {
      //continue;
      printf("%d: type1 %dx%d %d bytes\n", i, stg->w, stg->h, stg->sz);
      pic_t *pic = picNew(stg->w, stg->h, 8);
      unrle((uint8_t*)(stg+1), pic->D, stg->w*stg->h);
      pic->P = new(uint8_t,4*256);
      pic->K = 0;
      uint8_t *q = pal;
      for (j = 0; j < 256; j++) {
        pic->P[j*4+0] = q[j*3 + 0]<<2;
        pic->P[j*4+1] = q[j*3 + 1]<<2;
        pic->P[j*4+2] = q[j*3 + 2]<<2;
        pic->P[j*4+3] = 0;
      }
      //picClear(pic, 0xFF00FF);
      pngSave(fmt("%s%04dt1.png",outpath, i), pic);
    } else if (stg2->type==2 && stg2->w && stg2->h && stg2->sz && stg2->w <= 320 && stg2->h <= 200 && stg2->sz <= 320*200+0xE) {
      //continue;
      printf("%d: type2 %dx%d (%d,%d) %d bytes\n", i, stg2->w, stg2->h, stg2->x, stg2->y, stg2->sz);
      pic_t *pic = picNew(stg2->w, stg2->h, 8);
      unrle((uint8_t*)(stg2+1), pic->D, stg2->w*stg2->h);
      pic->P = new(uint8_t,4*256);
      pic->K = 0;
      for (j = 0; j < 256; j++) {
        pic->P[j*4+0] = pal[j*3 + 0]<<2;
        pic->P[j*4+1] = pal[j*3 + 1]<<2;
        pic->P[j*4+2] = pal[j*3 + 2]<<2;
        pic->P[j*4+3] = 0;
      }
      pngSave(fmt("%s%04dt2.png",outpath, i), pic);
    } else if (stg3->type==3 && stg3->sz && stg3->sz <= ct[i].sz && !stg3->w && !stg3->h) {
      //continue;
      printf("%d: type3 %dx%d\n", i, stg3->w, stg3->h);
      write_whole_file_path(fmt("%s%04dt3.b",outpath, i),
         file+ct[i].ofs, ct[i].sz);
    } else if (stg4->type==4 && stg4->w && stg4->h && stg4->sz && stg4->w <= 320 && stg4->h <= 200 && stg4->sz <= 320*200+sizeof(stg4_t)) {
      //continue;
      printf("%d: type4 %dx%d (%d,%d) %d bytes\n", i, stg4->w, stg4->h, stg4->x, stg4->y, stg4->sz);
      pic_t *pic = picNew(stg4->w, stg4->h, 8);
      unrle((uint8_t*)(stg4+1), pic->D, stg4->w*stg4->h);
      pic->P = new(uint8_t,4*256);
      uint8_t *upal = file+ct[741].ofs;
      pic->K = 0;
      for (j = 0; j < 256; j++) {
        pic->P[j*4+0] = upal[j*3 + 0]<<2;
        pic->P[j*4+1] = upal[j*3 + 1]<<2;
        pic->P[j*4+2] = upal[j*3 + 2]<<2;
        pic->P[j*4+3] = 0;
      }
      pngSave(fmt("%s%04dt4.png",outpath, i), pic);
    } else if (ct[i].sz==768) {
      pal = file+ct[i].ofs;
      //continue;
      printf("%d: palette\n", i);
      pic_t *pic = picNew(16, 16, 8);
      pic->P = new(uint8_t,4*256);
      uint8_t *q = file+ct[i].ofs;
      for (j = 0; j < 256; j++) {
        pic->P[j*4+0] = q[j+3 + 0]<<2;
        pic->P[j*4+1] = q[j+3 + 1]<<2;
        pic->P[j*4+2] = q[j+3 + 2]<<2;
        pic->P[j*4+3] = 0;
        picPut(pic, j%16, j/16, j);
      }
      //picClear(pic, 0xFF00FF);
      pngSave(fmt("%s%04d_pal.png",outpath, i), pic);
    } else if (is_txt(file+ct[i].ofs, ct[i].sz)) {
      //continue;
      printf("%d: dumping txt...\n", i);
      write_whole_file_path(fmt("%s%04d.txt",outpath, i), file+ct[i].ofs, ct[i].sz);
    } else {
      //continue;
      printf("%d: dumping raw...\n", i);
      write_whole_file_path(fmt("%s%04d.b",outpath, i), file+ct[i].ofs, ct[i].sz);
    }
  }
  printf("Done!\n");
#endif

  return 0;
}
